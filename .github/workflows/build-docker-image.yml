name: Build & Create Docker Image

on:
    workflow_call:
        inputs:
            image-name:
                required: true
                type: string

jobs:

  verify:
    strategy:
      matrix:
        arch: [X64, ARM64]
    runs-on: ${{ matrix.arch }}
    container: maven:3.8.6-jdk-11
    steps:
      - uses: actions/checkout@v3

      # - name: Set up JDK 11
      #   uses: actions/setup-java@v3
      #   with:
      #     java-version: '11'
      #     distribution: 'temurin'
      #     cache: maven

      - name: Verify
        run: mvn -B verify

  build:
    needs: verify
    strategy:
      matrix:
        arch: [X64, ARM64]
    runs-on: ${{ matrix.arch }}
    container: maven:3.8.6-jdk-11
    
    steps:
      - uses: actions/checkout@v3

      # - name: Set up JDK 11
      #   uses: actions/setup-java@v3
      #   with:
      #     java-version: '11'
      #     distribution: 'temurin'
      #     cache: maven

      - name: Build
        run: mvn -B clean install
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: spring-boot-jar
          path: target/*.jar
          retention-days: 1  
      
  image:
    needs: build
    strategy:
      matrix:
        arch: [X64, ARM64]
    runs-on: ${{ matrix.arch }}

    steps:

      - name: Download a single artifact
        uses: actions/download-artifact@v3
        with:
          name: spring-boot-jar
      
      - name: Delete Artifact
        uses: GeekyEggo/delete-artifact@v1.0.0
        with:
          name: spring-boot-jar

      - name: Create Image
        run: |

          architect=$(dpkg --print-architecture)
          final-image-name=${{ inputs.image-name }}-${ architect }

          mkdir -p extracted
          java -Djarmode=layertools -jar *.jar extract --destination extracted
          docker build -t ${ final-image-name } .

          docker image tag ${ final-image-name } 192.168.7.17:5000/${ final-image-name }:$(date "+%Y%m%d")
          docker image tag ${ final-image-name } 192.168.7.17:5000/${ final-image-name }:latest
          
          docker push 192.168.7.17:5000/${ final-image-name }:$(date "+%Y%m%d")
          docker push 192.168.7.17:5000/${ final-image-name }:latest

          docker image remove ${ final-image-name }
          docker image remove 192.168.7.17:5000/${ final-image-name }:$(date "+%Y%m%d")
          docker image remove 192.168.7.17:5000/${ final-image-name }:latest